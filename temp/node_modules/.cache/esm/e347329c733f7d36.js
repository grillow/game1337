let Player,BulletManager;_733‍.w("./game/player.js",[["Player",["Player"],function(v){Player=v}]]);_733‍.w("./game/bulletmanager.js",[["BulletManager",["BulletManager"],function(v){BulletManager=v}]]);

let bulletManager = new BulletManager()

var express = require('express')
var app = express()
var server = require('http').Server(app)

app.use('/', express.static(__dirname + '/client'))
app.use('/game', express.static(__dirname + '/game'))

server.listen(80)
console.log('Server started')


var io = require('socket.io')(server, {})
io.sockets.on('connection', function(socket){

    socket.logged = false

    socket.on('ping_latency', function(){
        socket.emit('pong_latency')
    })

    socket.on('disconnect', function(){
        if (!socket.logged)
            return
        io.sockets.emit('system_message', socket.Player.nickname + ' disconnected')
        scoreboard_update()
    })
    
    socket.on('login', function(nickname, color){
        if (!(typeof(nickname)=='string') || socket.logged || !/^[a-zA-Zа-яА-ЯёЁ0-9_- ]+$/.test(nickname) || !(typeof(color)=='string') || !/[0-9A-F]{6}/.test(color)){
            socket.emit('login_failure')
            return
        }

        socket.logged = true
        socket.Player = new Player(socket.id, nickname)
        socket.Player.color = '#' + color
        socket.Player.respawn()
        scoreboard_update()

        io.sockets.emit('system_message', socket.Player.nickname + ' connected')

        socket.on('message_post', function(message){
            _733‍.g.console.log(socket.Player.nickname + ': ' + message)
            if (typeof(message)!='string')
                return
            message = message.replace(/</g, '&lt;')
            message = message.replace(/>/g, '&gt;')
            io.sockets.emit('message_new', socket.Player.nickname, message, socket.Player.color)
        })

        socket.emit('login_success')
    })
    
    socket.on('input', function(dirX, dirY){
        if (!socket.logged)
            return
        if (!socket.Player.isAlive())
            return
        socket.Player.updateVelocity(dirX, dirY)
    })

    socket.on('mousemove', function(clientX, clientY){
        if (!socket.logged)
            return
        socket.Player.updateMousePosition(clientX, clientY)
    })

    socket.on('+shoot', function(){
        if (!socket.logged)
            return
        socket.Player.toshoot = true
    })
    socket.on('-shoot', function(){
        if (!socket.logged)
            return
        socket.Player.toshoot = false
    })
    
})

setInterval(function(){
    var players = []
    var sockets = io.sockets.sockets
    for (var id in sockets){
        if (!sockets[id].logged)
            continue
        var player = sockets[id].Player
        if (!player.isAlive())
            continue
        player.updatePosition()
        player.updateAmmo()
        player.updateStreak_ticks()
        player.shoot(bulletManager)
        players.push(player)
    }
    bulletManager.update()
    bulletManager.collide(players)
    let sb_update = false
    players.forEach(player => {
        if (player.hit){
            player.hit = false
            if (sockets[player.attacker] && sockets[player.attacker].logged)
                sockets[player.attacker].emit('hit', player.X, player.Y)
        }
        if (!player.isAlive() && !player.deathNotified){
            let victim = sockets[player.id].Player
            if (!sockets[player.attacker]){
                io.sockets.emit('system_message', '&lt;unconnected&gt; killed ' + victim.nickname)
            }
            else{
                let attacker = sockets[player.attacker].Player
                io.sockets.emit('system_message', attacker.nickname + ' killed ' + victim.nickname)
                attacker.updateStreak()
                io.sockets.emit('update_streak', attacker.nickname, attacker.streak)
                attacker.kills++
            }
            sb_update = true
            victim.deaths++
            sockets[player.id].emit('death')
            player.deathNotified = true
            setTimeout(function(){
                player.respawn()
                if (sockets[player.id])
                    sockets[player.id].emit('respawn')
            }, 3000)
        }
    })
    var players_simplified = []
    for (var id in sockets){
        if (!sockets[id].logged)
            continue
        var player = sockets[id].Player
        if (!player.isAlive())
            continue
        players_simplified.push(player.getSimplified())
    }
    io.sockets.emit('gametick', players_simplified, bulletManager.getSimplified())
    
    //update scoreboard
    if (sb_update){
        scoreboard_update()
    }
    
}, 20)

function scoreboard_update(){
    var players = []
    var sockets = io.sockets.sockets
    for (var id in sockets){
        var player = sockets[id].Player
        if (!sockets[id].logged)
            continue
        players.push(player.getSimplifiedScore())
    }
    players.sort((a, b) => a.kills < b.kills)
    //players = players.slice(0, 9)
    io.sockets.emit('scoreboard', players)
}
